<app-HeaderPropio></app-HeaderPropio>

<section class="turnos-especialista">
  <h2>Mis Turnos</h2>

  <input
    type="text"
    placeholder="Buscar por nombre, paciente o dato cl√≠nico..."
    [(ngModel)]="filtro"
    (input)="aplicarFiltroConDebounce()"
  />

  <app-loading *ngIf="loading"></app-loading>

  <div *ngIf="!loading && filtrado.length > 0; else sinTurnos" class="lista-turnos-especialista">
    <div *ngFor="let t of filtrado" class="tarjeta-turno">
      <h3>{{ t.especialidad | empty:'Sin especialidad' }}</h3>

      <p>
        <strong>Paciente:</strong>
        {{ t.usuarios_pacientes | nombreCompleto }}
      </p>
      <p><strong>Fecha:</strong> {{ t.fecha | date }}</p>
      <p><strong>Hora:</strong> {{ t.hora | empty:'‚Äî' }}</p>
      <p>
        <strong>Estado:</strong>
        <span class="estado {{ t.estado }}">{{ t.estado | titlecase }}</span>
      </p>

      <div class="acciones">
        <button
          *ngIf="puedeAceptar(t)"
          appBotonColor="ver"
          (click)="aceptarTurno(t)"
        >
          Aceptar
        </button>

        <button
          *ngIf="puedeCancelar(t)"
          appBotonColor="cancelar"
          (click)="abrirModalComentario(t, 'cancelado')"
        >
          Cancelar
        </button>

        <button
          *ngIf="t.estado === 'cancelado'"
          appBotonColor="motivo"
          (click)="verMotivoCancelacion(t)"
        >
          Ver Motivo
        </button>

        <button
          *ngIf="puedeFinalizar(t)"
          appBotonColor="ver"
          (click)="abrirModalComentario(t, 'finalizado')"
        >
          Finalizar
        </button>

        <button
          *ngIf="puedeVerResena(t)"
          appBotonColor="rese√±a"
          (click)="verResena(t)"
        >
          Ver Rese√±a
        </button>
      </div>
    </div>
  </div>

  <ng-template #sinTurnos>
    <p class="sin-turnos">No hay turnos asignados.</p>
  </ng-template>

  <!-- MODAL RESE√ëA / CANCELACI√ìN -->
  <div class="modal-overlay" *ngIf="mostrarModalResena">
    <div class="modal-contenido">
      <h3>
        ü©∫
        {{
          detallesSeleccionados[0]?.tipo === 'cancelacion'
            ? 'Motivo de Cancelaci√≥n'
            : 'Rese√±a del Turno'
        }}
      </h3>

      <p class="turno-info">
        <strong>Paciente:</strong>
        {{ turnoSeleccionado?.usuarios_pacientes | nombreCompleto }}<br />
        <strong>Especialidad:</strong>
        {{ turnoSeleccionado?.especialidad | empty:'Sin especialidad' }}<br />
        <strong>Fecha:</strong> {{ turnoSeleccionado?.fecha | date }}
      </p>

      <div *ngFor="let d of detallesSeleccionados" class="bloque-resena">
        <span class="tipo">
          {{
            d.tipo === 'cancelacion' ? 'Motivo de cancelaci√≥n' : d.titulo || (d.tipo | titlecase)
          }}
        </span>

        <p [innerHTML]="d.contenido || d.texto || d.comentario | empty:'Sin contenido'"></p>

        <div class="autor-cancelacion" *ngIf="d.autor">
          <strong>{{ d.autor }}</strong>
        </div>

        <small>{{ d.creado_en | date : 'short' }}</small>
      </div>

      <button appBotonColor="cancelar" (click)="cerrarModalResena()">Cerrar</button>
    </div>
  </div>

  <!-- MODAL ACCI√ìN -->
  <div class="modal-overlay" *ngIf="mostrarModalComentario">
    <div class="modal-cancelacion">
      <div class="modal-header">
        <h3>{{ accionLabel }} Turno</h3>
      </div>

      <ng-container *ngIf="accionPendiente === 'finalizado'; else comentarioSimple">
        <p class="mensaje">Complet√° los datos de la historia cl√≠nica:</p>

        <div class="form-historia">
          <div class="campo">
            <label>Altura (cm)</label>
            <input
              type="number"
              [(ngModel)]="historia.altura_cm"
              placeholder="Ej: 175"
              appOnlyNumber
            />
          </div>

          <div class="campo">
            <label>Peso (kg)</label>
            <input
              type="number"
              [(ngModel)]="historia.peso_kg"
              placeholder="Ej: 70"
              appOnlyNumber
            />
          </div>

          <div class="campo">
            <label>Temperatura (¬∞C)</label>
            <input
              type="number"
              step="0.1"
              [(ngModel)]="historia.temperatura_c"
              placeholder="Ej: 36.7"
              appOnlyNumber
            />
          </div>

          <div class="campo">
            <label>Presi√≥n</label>
            <input type="text" [(ngModel)]="historia.presion" placeholder="Ej: 120/80" />
          </div>

          <div class="extras">
            <h4>Datos adicionales (m√°x. 3)</h4>
            <div *ngFor="let e of extras; let i = index" class="fila-extra">
              <input type="text" [(ngModel)]="e.clave" placeholder="Clave (ej: caries)" />
              <input type="text" [(ngModel)]="e.valor" placeholder="Valor (ej: 4)" />
            </div>
            <button type="button" class="btn-add" (click)="agregarExtra()">+ Agregar campo</button>

            <div class="comentario-section">
              <label for="comentario" class="comentario-label">
                Comentario para el paciente:
              </label>
              <textarea
                id="comentario"
                [(ngModel)]="comentarioAccion"
                placeholder="Escrib√≠ aqu√≠ un comentario o recomendaci√≥n para el paciente..."
                rows="3"
              ></textarea>
            </div>
          </div>
        </div>
      </ng-container>

      <ng-template #comentarioSimple>
        <p class="mensaje">
          Por favor, explic√° brevemente el motivo de la {{ accionLabel | lowercase }}:
        </p>
        <textarea
          [(ngModel)]="comentarioAccion"
          placeholder="Escrib√≠ tu comentario aqu√≠..."
          rows="4"
          class="campo-texto"
        ></textarea>
      </ng-template>

      <div class="modal-actions">
        <button appBotonColor="ver" (click)="confirmarAccion()">Confirmar</button>
        <button appBotonColor="cancelar" (click)="cerrarModalComentario()">Cancelar</button>
      </div>
    </div>
  </div>
</section>
