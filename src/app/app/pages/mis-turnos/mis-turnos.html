<app-HeaderPropio></app-HeaderPropio>
<section class="mis-turnos">
  <h2>Mis Turnos</h2>

  <!-- üîç Filtros -->
  <div class="filtros">
    <input
      type="text"
      placeholder="Filtrar por especialidad o especialista..."
      [(ngModel)]="filtro"
      (input)="aplicarFiltro()"
    />
    </div>
  <!-- ‚è≥ Loading -->
  <app-loading *ngIf="loading"></app-loading>

  <!-- üìã Lista de turnos -->
  <div class="lista-turnos" *ngIf="!loading && filtrado.length > 0; else sinTurnos">
    <div *ngFor="let t of filtrado" class="turno">
      <div class="info">
        <p><strong>Especialidad:</strong> {{ t.especialidad }}</p>
        <p><strong>Especialista:</strong> {{ t.usuarios_especialistas?.nombre }} {{ t.usuarios_especialistas?.apellido }}</p>
        <p><strong>Fecha:</strong> {{ t.fecha | date }}</p>
        <p><strong>Hora:</strong> {{ t.hora }}</p>
        <p><strong>Estado:</strong> <span class="estado {{ t.estado }}">{{ t.estado | titlecase }}</span></p>
      </div>

      <!-- üß≠ Acciones -->
      <div class="acciones">
        <button
          *ngIf="puedeCancelar(t)"
          class="cancelar"
          (click)="abrirModalAccion(t, 'cancelado')"
        >
          Cancelar
        </button>

        <button
          *ngIf="puedeVerResena(t)"
          class="encuesta"
          (click)="verResena(t)"
        >
          Ver Rese√±a
        </button>

        <button
          *ngIf="puedeCompletarEncuesta(t)"
          class="encuesta"
          (click)="abrirModalAccion(t, 'encuesta')"
        >
          Completar Encuesta
        </button>

        <button
          *ngIf="puedeCalificar(t)"
          class="encuesta"
          (click)="abrirModalAccion(t, 'calificacion')"
        >
          Calificar Atenci√≥n
        </button>
      </div>
    </div>
  </div>

  <!-- üí§ Sin turnos -->
  <ng-template #sinTurnos>
    <p style="text-align: center; color: #888;">No hay turnos registrados.</p>
  </ng-template>

  <!-- ü©∫ Modal Rese√±a -->
  <div class="modal-overlay" *ngIf="mostrarModalResena">
    <div class="modal-contenido">
      <h3>ü©∫ Rese√±a del Turno</h3>

      <p class="turno-info">
        <strong>Especialista:</strong>
        {{ turnoSeleccionado?.usuarios_especialistas?.nombre }}
        {{ turnoSeleccionado?.usuarios_especialistas?.apellido }}<br />
        <strong>Especialidad:</strong> {{ turnoSeleccionado?.especialidad }}<br />
        <strong>Fecha:</strong> {{ turnoSeleccionado?.fecha | date }}
      </p>

      <div class="comentarios">
        <div *ngFor="let d of detallesSeleccionados" class="comentario">
          <span class="tipo">{{ d.tipo | titlecase }}</span>
          <p>{{ d.comentario }}</p>
          <small>{{ d.creado_en | date: 'short' }}</small>
        </div>
      </div>

      <button class="cerrar-btn" (click)="cerrarModalResena()">Cerrar</button>
    </div>
  </div>

  <!-- üìù Modal Comentarios (Cancelar / Encuesta / Calificar) -->
  <div class="modal-overlay" *ngIf="mostrarModalAccion">
    <div class="modal-contenido">
      <h3>{{ accionPendiente | titlecase }}</h3>
      <p>Por favor ingrese un comentario:</p>
      <textarea
        [(ngModel)]="comentarioAccion"
        placeholder="Escriba su comentario..."
        rows="4"
      ></textarea>

      <div class="modal-buttons">
        <button class="confirmar-btn" (click)="confirmarAccion()">Confirmar</button>
        <button class="cerrar-btn" (click)="cerrarModalAccion()">Cancelar</button>
      </div>
    </div>
  </div>
</section>
