<app-HeaderPropio></app-HeaderPropio>

<section class="solicitar-turno">
  <div class="contenedor-turno">
    <h2>ü©∫ Solicitar Turno</h2>

    <div *ngIf="!especialidadSeleccionada" class="paso fade-in">
      <h3>Seleccion√° una especialidad</h3>
      <div class="lista">
        <button
          *ngFor="let e of especialidades"
          (click)="especialidadSeleccionada = e; cargarEspecialistas()"
          class="btn-opcion"
        >
          {{ e }}
        </button>
      </div>
    </div>

    <div *ngIf="especialidadSeleccionada && !especialistaSeleccionado" class="paso fade-in">
      <button class="btn-volver" (click)="resetearFormulario()">‚Üê Volver</button>
      <h3>Seleccion√° un especialista</h3>
      <div class="lista">
        <div
          *ngFor="let esp of especialistas"
          class="card-opcion"
          [class.seleccionado]="especialistaSeleccionado?.id === esp.id"
          (click)="seleccionarEspecialista(esp)"
        >
          <img *ngIf="esp.foto_url" [src]="esp.foto_url" alt="Foto especialista" />
          <span>{{ esp.usuarios?.nombre }} {{ esp.usuarios?.apellido }}</span>
        </div>
      </div>
    </div>

    <div *ngIf="especialistaSeleccionado && !fechaSeleccionada" class="paso fade-in">
      <button class="btn-volver" (click)="especialistaSeleccionado = null">‚Üê Volver</button>
      <h3>Seleccion√° una fecha (pr√≥ximos 15 d√≠as)</h3>

      <div class="lista" *ngIf="fechasDisponibles.length > 0; else sinFechas">
        <button
          *ngFor="let f of fechasDisponibles"
          class="btn-opcion"
          [class.seleccionado]="fechaSeleccionada === f"
          (click)="fechaSeleccionada = f; cargarHorariosDisponibles()"
        >
          {{ formatearFecha(f) }}
        </button>
      </div>

      <ng-template #sinFechas>
        <div class="mensaje-vacio">
          <p>üìÖ No hay fechas disponibles para este especialista en los pr√≥ximos d√≠as.</p>
        </div>
      </ng-template>
    </div>

    <div *ngIf="fechaSeleccionada && !horaSeleccionada" class="paso fade-in">
      <button class="btn-volver" (click)="fechaSeleccionada = ''">‚Üê Volver</button>
      <h3>Seleccion√° un horario disponible</h3>

      <div class="lista" *ngIf="horariosDisponibles.length > 0; else sinHorarios">
        <button
          *ngFor="let h of horariosDisponibles"
          class="btn-opcion"
          [class.seleccionado]="horaSeleccionada === h"
          (click)="horaSeleccionada = h"
        >
          {{ h }}
        </button>
      </div>

      <ng-template #sinHorarios>
        <div class="mensaje-vacio">
          <p>‚è∞ No hay horarios disponibles para la fecha seleccionada.</p>
        </div>
      </ng-template>
    </div>

    <div *ngIf="horaSeleccionada && esAdmin && !pacienteSeleccionado" class="paso fade-in">
      <button class="btn-volver" (click)="horaSeleccionada = ''">‚Üê Volver</button>
      <h3>Seleccion√° un paciente</h3>
      <div class="lista">
        <button
          *ngFor="let p of pacientes"
          class="btn-opcion"
          [class.seleccionado]="pacienteSeleccionado === p.id"
          (click)="pacienteSeleccionado = p.id"
        >
          {{ p.nombre }} {{ p.apellido }}
        </button>
      </div>
    </div>

    <div *ngIf="horaSeleccionada && (!esAdmin || pacienteSeleccionado)" class="paso fade-in">
      <button
        class="btn-volver"
        (click)="esAdmin ? (pacienteSeleccionado = null) : (horaSeleccionada = '')"
      >
        ‚Üê Volver
      </button>
      <h3>Confirmar turno</h3>
      <p class="resumen">
        <strong>Especialidad:</strong> {{ especialidadSeleccionada }} <br />
        <strong>Especialista:</strong> {{ especialistaSeleccionado?.usuarios?.nombre }}
        {{ especialistaSeleccionado?.usuarios?.apellido }} <br />
        <strong>Fecha:</strong> {{ formatearFecha(fechaSeleccionada) }} <br />
        <strong>Hora:</strong> {{ horaSeleccionada }}
      </p>
      <button class="btn-confirmar" (click)="confirmarTurno()">Confirmar Turno</button>
    </div>
  </div>
</section>
