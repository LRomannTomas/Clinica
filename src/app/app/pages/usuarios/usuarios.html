<app-HeaderPropio></app-HeaderPropio>

<section class="usuarios">
  <ng-container *ngIf="vista === 'tabla'">
    <h2>üë• Gesti√≥n de Usuarios</h2>

    <app-loading *ngIf="loading"></app-loading>
    <p *ngIf="mensaje && !loading">{{ mensaje }}</p>

    <button class="nuevo-btn" appBotonColor="ver" (click)="irA('tipo')">
      + Crear Usuario +
    </button>

    <div *ngIf="!loading && usuarios.length > 0; else vacio" class="lista-usuarios">
      <div *ngFor="let u of usuarios" class="usuario-card">
        <div class="info">
          <div class="img-container">
            <img
              [src]="u.foto | empty:'assets/images/default-user.png'"
              alt="{{ u.nombre }}"
              class="avatar"
            />
          </div>

          <div class="datos">
            <h3>{{ u | nombreCompleto }}</h3>
            <p><strong>Perfil:</strong> {{ u.perfil | titlecase }}</p>
            <p><strong>Email:</strong> {{ u.email | empty:'Sin email' }}</p>
            <p><strong>DNI:</strong> {{ u.dni | dni }}</p>

            <p *ngIf="u.perfil === 'especialista'">
              <strong>Aprobado:</strong> {{ u.aprobado ? 'S√≠ ‚úÖ' : 'No ‚ùå' }}
            </p>
          </div>
        </div>

        <div class="acciones">
          <button
            *ngIf="u.perfil === 'especialista'"
            appBotonColor="ver"
            (click)="toggleAprobado(u)"
          >
            {{ u.aprobado ? 'Inhabilitar' : 'Aprobar' }}
          </button>

          <button appBotonColor="cancelar" (click)="eliminarUsuario(u)">
            Eliminar
          </button>

          <button
            *ngIf="u.perfil === 'paciente'"
            appBotonColor="motivo"
            (click)="verHistoria(u)"
          >
            üìã Ver historia cl√≠nica
          </button>
        </div>
      </div>
    </div>

    <ng-template #vacio>
      <p class="vacio">No hay usuarios registrados.</p>
    </ng-template>

    <div class="modal-overlay" *ngIf="mostrarModal">
      <div class="modal-contenido">
        <div class="modal-header">
          <h3>
            üìã Historias de {{ pacienteSeleccionado | nombreCompleto }}
          </h3>
        </div>

        <div *ngIf="historiasSeleccionadas.length > 0; else sinHistorias" class="modal-body">
          <div *ngFor="let h of historiasSeleccionadas" class="historia-card">
            <div class="cabecera">
              <div>
                <h4>{{ h.turnos?.especialidad | empty:'Sin especialidad' }}</h4>
                <span class="fecha">{{ h.turnos?.fecha | date:'longDate':'':'es' }}</span>
              </div>
            </div>

            <div class="datos-fijos">
              <p><strong>Altura:</strong> {{ h.altura_cm | empty:'‚Äî' }} cm</p>
              <p><strong>Peso:</strong> {{ h.peso_kg | empty:'‚Äî' }} kg</p>
              <p><strong>Temperatura:</strong> {{ h.temperatura_c | empty:'‚Äî' }} ¬∞C</p>
              <p><strong>Presi√≥n:</strong> {{ h.presion | empty:'‚Äî' }}</p>
            </div>

            <div *ngIf="h.extras?.length > 0" class="extras">
              <h5>ü©∫ Datos adicionales</h5>
              <ul>
                <li *ngFor="let e of h.extras">
                  <strong>{{ e.clave | empty:'‚Äî' }}:</strong>
                  {{ e.valor | empty:'‚Äî' }}
                </li>
              </ul>
            </div>
          </div>
        </div>

        <ng-template #sinHistorias>
          <p class="sin-historias">Este paciente no tiene historias registradas.</p>
        </ng-template>

        <div class="modal-footer">
          <button appBotonColor="cancelar" (click)="cerrarModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="vista === 'tipo'">
    <button class="btn-volver" appBotonColor="cancelar" (click)="volverAlInicio()">‚Üê Volver</button>
    <h2>Seleccion√° el tipo de usuario</h2>

    <div class="opciones-perfil">
      <div class="opcion" (click)="seleccionarTipo('admin')">
        <img src="assets/images/admin.png" alt="Administrador" />
        <span>Administrador</span>
      </div>
      <div class="opcion" (click)="seleccionarTipo('especialista')">
        <img src="assets/images/medico.png" alt="Especialista" />
        <span>Especialista</span>
      </div>
      <div class="opcion" (click)="seleccionarTipo('paciente')">
        <img src="assets/images/paciente.png" alt="Paciente" />
        <span>Paciente</span>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="vista === 'form'">
    <button class="btn-volver" appBotonColor="cancelar" (click)="volverASeleccion()">‚Üê Volver</button>
    <h2>Crear {{ tipoSeleccionado | titlecase }}</h2>

    <form [formGroup]="form" (ngSubmit)="crearUsuario()">
      <div class="form-container">
        <div class="grid">
          <input formControlName="nombre" placeholder="Nombre" />
          <input formControlName="apellido" placeholder="Apellido" />
          <input type="number" formControlName="edad" placeholder="Edad" />
          <input formControlName="dni" placeholder="DNI" />
          <input type="email" formControlName="email" placeholder="Email" />
          <input type="password" formControlName="password" placeholder="Contrase√±a" />
          <input
            *ngIf="tipoSeleccionado === 'paciente'"
            formControlName="obra_social"
            placeholder="Obra Social"
          />
        </div>

        <div class="imagen-selector">
          <label for="fotoInput" class="custom-upload">
            <span class="bi bi-image"></span>
            Seleccionar {{ tipoSeleccionado === 'paciente' ? '2 im√°genes' : 'imagen' }}
          </label>
          <input
            id="fotoInput"
            type="file"
            [attr.multiple]="tipoSeleccionado === 'paciente' ? '' : null"
            accept="image/*"
            (change)="onFotosSeleccionadas($event)"
          />
          <div *ngIf="fotos.length > 0" class="preview">
            <p>{{ fotos.length }} archivo(s) seleccionado(s)</p>
          </div>
        </div>

        <button type="submit" appBotonColor="ver" [disabled]="loading">Crear Usuario</button>
      </div>
    </form>
  </ng-container>
</section>

<button class="btn-excel" (click)="descargarExcel()" title="Descargar Excel">
  <img src="assets/images/excel-icono.png" alt="Descargar Excel" />
</button>
